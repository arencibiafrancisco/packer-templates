packer {
  required_plugins {
    xenserver = {
      version = ">= v0.7.0"
      source  = "github.com/ddelnano/xenserver"
    }
  }
}

variable "remote_host" {
  type        = string
  description = "The IP or FQDN of your XCP-ng. It must be the master"
  sensitive   = true
  default     = "10.35.1.6"
}

variable "remote_username" {
  type        = string
  description = "The username used to interact with your XCP-ng"
  sensitive   = true
  default     = "root"
}

variable "remote_password" {
  type        = string
  description = "The password used to interact with your XCP-ng"
  sensitive   = true
  default     = "Node_Password"
}

variable "sr_iso_name" {
  type        = string
  description = "The ISO-SR Packer will use"
  default     = "PROD172_NFS171COREC14_ST19_ISOS"
}

variable "sr_name" {
  type        = string
  description = "The name of the SR Packer will use"
  default     = "PROD171_NFS171COREC14_ST19"
}

source "xenserver-iso" "windows2022" {
  iso_checksum                 = "7a7d4c64536f0e705ca05657a31b2efcbed7aafe981ee24af4b12dc5ab7132299f20fda3c141b6eebe0e45aae77b8a8a5052afbdc6fed700bdd1efaf8f3176e2"
  iso_url                      = "http://10.35.10.130:8081/repository/ISOS/WindowsServer2022EN.iso"
  sr_iso_name                  = var.sr_iso_name
  sr_name                      = var.sr_name
  remote_host                  = var.remote_host
  remote_password              = var.remote_password
  remote_username              = var.remote_username
  ssh_disable_agent_forwarding = true
  ssh_pty                      = true

  boot_command = [
    "<wait><wait><wait><enter>"
  ]

  vm_name         = "Win2022EN_template"
  vm_description  = "VM for Windows Server 2022 EN"
  vcpus_max       = 4
  vcpus_atstartup = 4
  vm_memory       = 16384 # MB
  network_names   = ["MAD4-CORE-ADM-MGMT-VLAN60"]
  disk_size       = 81920 # MB
  disk_name       = "Win2022EN_template_disk"
  floppy_files = [
    "./floppy/en22/autounattend.xml",
    "./floppy/en22/cloudbase-init-unattend.conf",
    "./floppy/en22/cloudbase-init.conf",
    "./floppy/en22/Unattend.xml",
    "./floppy/en22/winunattend.xml",
    "./scripts/Cleanup.ps1",
    "./scripts/ConfigureRemotingForAnsible.ps1",
    "./scripts/CopyFiles.ps1",
    "./scripts/WinUpdate.ps1",
    "./scripts/InstallInitialSetup.ps1",
    "./scripts/Sysprep.ps1"
  ]
  vm_tags                = ["Generated by Packer"]
  communicator           = "winrm"
  winrm_username         = "Administrator"
  winrm_password         = "Password2022!"
  winrm_timeout          = "6h"
  winrm_insecure         = true
  winrm_use_ssl          = true
  ssh_username           = "Administrator"
  ssh_password           = "Password2022!"
  ssh_wait_timeout       = "60000s"
  ssh_handshake_attempts = 10000
  output_directory       = "packer-Win2022EN"
  keep_vm                = "never"
  format                 = "vdi_vhd"
  shutdown_command       = "shutdown /s /t 5 /f /d p:4:1 /c \\\"Packer Shutdown\\\""
}

build {
  name    = "Win2022EN-XenServer"
  sources = ["xenserver-iso.windows2022"]

  provisioner "powershell" {
    scripts          = ["scripts/WinUpdate.ps1"]
    valid_exit_codes = [0, 2300218]
  }

  provisioner "windows-restart" {
    pause_before    = "30s"
    restart_timeout = "30m"
  }

  provisioner "powershell" {
    scripts = ["scripts/WinUpdate.ps1"]
  }

  provisioner "windows-restart" {
    restart_timeout = "30m"
  }

  provisioner "powershell" {
    scripts = ["scripts/Cleanup.ps1"]
  }

  provisioner "powershell" {
    scripts = ["scripts/Sysprep.ps1"]
  }
}
